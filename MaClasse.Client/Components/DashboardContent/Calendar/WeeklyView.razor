@using System.Globalization

<div class="calendar-grid"
     style="display: grid;
            grid-template-columns: 5rem repeat(7, 6rem);
            grid-template-rows: 3rem repeat(12, 5rem);
            position: relative;
            width: 100%;">

    @foreach (var (day, index) in WeekDays.Select((d, i) => (d, i)))
    {
        <div style="grid-column: @(index + 2); grid-row: 1; text-align: center;">
            <div>@day.ToString("dddd", new CultureInfo("fr-FR"))</div>
            <div>@day.ToString("dd MMMM", new CultureInfo("fr-FR"))</div>
        </div>
    }

    @foreach (var (hour, i) in Hours.Select((h, i) => (h, i)))
    {
        <div style="grid-column: 1; grid-row: @(i + 2); padding-top: 1rem;">
            @hour:00
        </div>
    }

    @foreach (var ev in Events)
    {
        var start = ev.Start ?? DateTime.Now;
        var end = ev.End ?? start.AddHours(1);

        // ✅ Correction ici : comparaison sur .Date pour éviter les erreurs liées à l'heure
        var dayIndex = WeekDays.ToList().FindIndex(d => d.Date == start.Date);
        var startHourIndex = Hours.ToList().FindIndex(h => h == start.Hour);

        if (dayIndex == -1 || startHourIndex == -1) continue;

        var topOffset = GetTopOffset(start);
        var heightRem = GetHeight(start, end);

        var top = topOffset.ToString("F2", CultureInfo.InvariantCulture);
        var height = heightRem.ToString("F2", CultureInfo.InvariantCulture);
        var left = $"calc(6rem * {dayIndex})";

        var style = $"grid-column: {dayIndex + 2}; " +
                    $"grid-row: {startHourIndex + 2}; " +
                    $"position: absolute; " +
                    $"margin-top: {top}rem; " +
                    $"height: {height}rem; " +
                    $"left: {left}; " +
                    $"width: 5.5rem; " +
                    $"padding: 0.25rem; " +
                    $"box-sizing: border-box; " +
                    $"z-index: 5;";

        <div style="@style">
            <MudPaper Class="p-2 bg-primary text-white rounded" Style="height: 100%;">
                <b>@ev.Title</b><br />
                @ev.Start?.ToString("HH:mm") - @ev.End?.ToString("HH:mm")<br />
                <small>@ev.Location</small>
            </MudPaper>
        </div>
    }

</div>
